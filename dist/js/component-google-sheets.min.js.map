{"version":3,"sources":["google-sheets-component.js"],"names":["app","googleSheetsService","$http","$q","$sce","self","worksheets","setWorksheets","resolve","reject","url","sheetID","method","trustAsResourceUrl","then","res","parser","DOMParser","entries","parseFromString","data","querySelectorAll","e","i","length","temp","children","childNodes","c","tagName","toLowerCase","id","textContent","split","title","err","read","worksheet","query","defaultWorksheet","lastUpdated","xmlDoc","Date","querySelector","result","indexOf","google_url","Object","keys","searchResults","r","q","o","parseFloat","create","dataToSend","hex","angular","toJson","charCodeAt","toString","confirmationID","getTime","postUrl","domain","scriptID","encodeURIComponent","getNewData","confirmationid","catch","init","clearTimeout","timer","sheetId","scriptId","setTimeout","$inject","service","module"],"mappings":"CAAA,SAAWA,GAQV,SAASC,EAAoBC,EAAOC,EAAIC,GAEvC,IAAIC,GAGHC,cAGAC,cAAe,WACd,OAAOJ,EAAG,SAAUK,EAASC,GAC5B,IAAIC,EAAM,oDAAsDC,EAAU,iBAE1ET,GACCU,OAAQ,QACRF,IAAKN,EAAKS,mBAAmBH,KAC3BI,KAAK,SAAUC,GACjB,IAAIC,EAAS,IAAIC,UAAaC,KAE9B,IAECA,EADaF,EAAOG,gBAAgBJ,EAAIK,KAAM,YAC7BC,iBAAiB,SACjC,MAAOC,GACRb,EAAOa,GAGR,IAAK,IAAIC,EAAI,EAAGA,EAAIL,EAAQM,OAAQD,GAAQ,EAAG,CAI9C,IAAK,IAHDE,KACAC,EAAWR,EAAQK,GAAGI,WAEjBC,EAAI,EAAGA,EAAIF,EAASF,OAAQI,GAAQ,EACxCF,EAASE,KAC8B,OAAtCF,EAASE,GAAGC,QAAQC,gBACvBL,EAAKM,GAAKL,EAASE,GAAGI,YAAYC,MAAM,KAAKP,EAASE,GAAGI,YAAYC,MAAM,KAAKT,OAAS,IAGhD,UAAtCE,EAASE,GAAGC,QAAQC,gBACvBL,EAAKS,MAAQR,EAASE,GAAGI,cAK5B3B,EAAKC,WAAWmB,EAAKM,IAAMN,EAG5BjB,EAAQH,EAAKC,aACX,SAAU6B,GACZ1B,EAAO0B,QAOVC,KAAM,SAAUC,EAAWC,GAC1B,OAAOnC,EAAG,SAAUK,EAASC,GAG5B,IAAIC,EAAM,8CAAgDC,EAAU,KAFpE0B,EAAYA,GAAaE,GAE6D,iBAEtFrC,GACCU,OAAQ,QACRF,IAAKN,EAAKS,mBAAmBH,KAC3BI,KAAK,SAAUC,GACjB,IAA4CyB,EAAaN,EAArDlB,EAAS,IAAIC,UAAaC,KAE9B,IACC,IAAIuB,EAASzB,EAAOG,gBAAgBJ,EAAIK,KAAM,YAC9CF,EAAUuB,EAAOpB,iBAAiB,SAClCmB,EAAc,IAAIE,KAAKD,EAAOE,cAAc,WAAWX,aACvDE,EAAQO,EAAOE,cAAc,SAASX,YACrC,MAAOV,GACRb,EAAOa,GASR,IAAK,IANDsB,GACHV,MAAOA,EACPM,YAAaA,EACbtB,YAGQK,EAAI,EAAGA,EAAIL,EAAQM,OAAQD,GAAQ,EAAG,CAI9C,IAAK,IAHDE,KACAC,EAAWR,EAAQK,GAAGI,WAEjBC,EAAI,EAAGA,EAAIF,EAASF,OAAQI,GAAQ,EACxCF,EAASE,KACRF,EAASE,GAAGC,QAAQC,cAAce,QAAQ,SAAW,EACxDpB,EAAKC,EAASE,GAAGC,QAAQI,MAAM,QAAQ,IAAMP,EAASE,GAAGI,YACT,OAAtCN,EAASE,GAAGC,QAAQC,gBAC9BL,EAAKqB,WAAapB,EAASE,GAAGI,YAC9BP,EAAKM,GAAKN,EAAKqB,WAAWb,MAAM,KAAKR,EAAKqB,WAAWb,MAAM,KAAKT,OAAS,KAKxEuB,OAAOC,KAAKvB,GAAMD,SACrBoB,EAAO1B,QAAQK,GAAKE,GAItB,GAAIa,EAAO,CACV,IAAIW,KAEJ,IAAK,IAAIC,KAAKN,EAAO1B,QACpB,IAAK,IAAIiC,KAAKb,EACb,IAAK,IAAIc,KAAKd,EAAMa,GACnB,OAAQC,GACP,IAAK,IACAR,EAAO1B,QAAQgC,GAAGC,IAAME,WAAWT,EAAO1B,QAAQgC,GAAGC,IAAMb,EAAMa,GAAGC,KACvEH,EAAcC,GAAKN,EAAO1B,QAAQgC,IAEnC,MAED,IAAK,IACAN,EAAO1B,QAAQgC,GAAGC,IAAME,WAAWT,EAAO1B,QAAQgC,GAAGC,IAAMb,EAAMa,GAAGC,KACvEH,EAAcC,GAAKN,EAAO1B,QAAQgC,IAEnC,MACD,IAAK,KACAN,EAAO1B,QAAQgC,GAAGC,IAAME,WAAWT,EAAO1B,QAAQgC,GAAGC,KAAOb,EAAMa,GAAGC,KACxEH,EAAcC,GAAKN,EAAO1B,QAAQgC,IAEnC,MAED,IAAK,KACAN,EAAO1B,QAAQgC,GAAGC,IAAME,WAAWT,EAAO1B,QAAQgC,GAAGC,KAAOb,EAAMa,GAAGC,KACxEH,EAAcC,GAAKN,EAAO1B,QAAQgC,IAEnC,MACD,IAAK,OACAN,EAAO1B,QAAQgC,GAAGC,IAAMP,EAAO1B,QAAQgC,GAAGC,GAAGN,QAAQP,EAAMa,GAAGC,KAAO,IACxEH,EAAcC,GAAKN,EAAO1B,QAAQgC,IAEnC,MACD,QACKN,EAAO1B,QAAQgC,GAAGC,IAAMP,EAAO1B,QAAQgC,GAAGC,KAAOb,EAAMa,GAAGC,KAC7DH,EAAcC,GAAKN,EAAO1B,QAAQgC,IASxC,OAFAN,EAAO1B,QAAU+B,EAEVzC,EAAQoC,GAGf,OAAOpC,EAAQoC,IAGd,SAAUT,GACZ,OAAO1B,EAAO0B,QAOjBmB,OAAQ,SAAUC,EAAYlB,GAE7B,IAAK,IAAIf,EAAI,EAAGA,EAAIiC,EAAW/B,OAAQF,IAAI,CAE1C,IAAK,IADDkC,EAAM,GACDjC,EAAI,EAAGA,EAAIkC,QAAQC,OAAOH,EAAWjC,IAAIE,OAAQD,IACzDiC,GAAO,GAAKC,QAAQC,OAAOH,EAAWjC,IAAIqC,WAAWpC,GAAGqC,SAAS,IAElEL,EAAWjC,GAAGuC,gBAAkB,IAAInB,MAAOoB,UAAa,IAAMN,EAG/D,IAAIO,EAAU,sCAAwCC,EAAS,MAAQC,EAAW,QAGlF,OAFAF,EAAUA,EAAU,WAAapD,EAAU,UAAYuD,mBAAmB7D,EAAKC,WAAW+B,GAAWH,OAAS7B,EAAKC,WAAWiC,GAAkBL,OAAS,SAAWgC,mBAAmBT,QAAQC,OAAOH,IAE/LpD,EAAG,SAAUK,EAASC,GAE5B,SAAS0D,IACR9D,EAAK+B,KAAKC,GAAWvB,KAAK,SAAUC,GAEnC,IAAK,IAAImC,KAAKnC,EAAIG,QACjB,GAAIH,EAAIG,QAAQgC,GAAGkB,iBAAmBb,EAAW,GAAGM,eACnD,OAAOrD,EAAQO,GAIjB,OAAON,EAAOM,KAIhBb,GACCU,OAAQ,QACRF,IAAKN,EAAKS,mBAAmBkD,KAE5BjD,KAAKqD,GAELE,MAAMF,MAMVG,KAAM,WACLC,aAAaC,GAETtE,EACHA,GACCU,OAAQ,MACRF,IAAK,uBACHI,KAAK,SAAUC,GACjBJ,EAAUI,EAAIK,KAAKqD,QACnBR,EAAWlD,EAAIK,KAAKsD,SACpBV,EAASjD,EAAIK,KAAK4C,OAClB3D,EAAKE,kBAGNiE,EAAQG,WAAW,WAClBtE,EAAKiE,QACH,OAON,OAFAjE,EAAKiE,OAEEjE,EApOR,IAAImE,EAAQ,KACR7D,EAAU,KACVsD,EAAW,KACXD,EAAS,KACTzB,EAAmB,MAmOvBtC,EAAoB2E,SACnB,QACA,KACA,QAGD5E,EAAI6E,QAAQ,sBAAuB5E,GA/OpC,CAgPGwD,QAAQqB,OAAO","file":"component-google-sheets.min.js","sourcesContent":["(function (app) {\n\n\tvar timer = null;\n\tvar sheetID = null;\n\tvar scriptID = null;\n\tvar domain = null;\n\tvar defaultWorksheet = 'od6';\n\n\tfunction googleSheetsService($http, $q, $sce) {\n\n\t\tvar self = {\n\n\n\t\t\tworksheets: {},\n\n\n\t\t\tsetWorksheets: function () {\n\t\t\t\treturn $q(function (resolve, reject) {\n\t\t\t\t\tvar url = 'https://spreadsheets.google.com/feeds/worksheets/' + sheetID + '/public/values';\n\n\t\t\t\t\t$http({\n\t\t\t\t\t\tmethod: 'jsonp',\n\t\t\t\t\t\turl: $sce.trustAsResourceUrl(url)\n\t\t\t\t\t}).then(function (res) {\n\t\t\t\t\t\tvar parser = new DOMParser(), entries = [];\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar xmlDoc = parser.parseFromString(res.data, \"text/xml\");\n\t\t\t\t\t\t\tentries = xmlDoc.querySelectorAll('entry');\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tfor (var i = 0; i < entries.length; i = i + 1) {\n\t\t\t\t\t\t\tvar temp = {};\n\t\t\t\t\t\t\tvar children = entries[i].childNodes;\n\n\t\t\t\t\t\t\tfor (var c = 0; c < children.length; c = c + 1) {\n\t\t\t\t\t\t\t\tif (children[c]) {\n\t\t\t\t\t\t\t\t\tif (children[c].tagName.toLowerCase() === 'id') {\n\t\t\t\t\t\t\t\t\t\ttemp.id = children[c].textContent.split('/')[children[c].textContent.split('/').length - 1];\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif (children[c].tagName.toLowerCase() === 'title') {\n\t\t\t\t\t\t\t\t\t\ttemp.title = children[c].textContent;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tself.worksheets[temp.id] = temp;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(self.worksheets);\n\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t},\n\n\n\n\t\t\tread: function (worksheet, query) {\n\t\t\t\treturn $q(function (resolve, reject) {\n\t\t\t\t\tworksheet = worksheet || defaultWorksheet;\n\n\t\t\t\t\tvar url = 'https://spreadsheets.google.com/feeds/list/' + sheetID + '/' + worksheet + '/public/values';\n\n\t\t\t\t\t$http({\n\t\t\t\t\t\tmethod: 'jsonp',\n\t\t\t\t\t\turl: $sce.trustAsResourceUrl(url)\n\t\t\t\t\t}).then(function (res) {\n\t\t\t\t\t\tvar parser = new DOMParser(), entries = [], lastUpdated, title, totalResults;\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar xmlDoc = parser.parseFromString(res.data, \"text/xml\");\n\t\t\t\t\t\t\tentries = xmlDoc.querySelectorAll('entry');\n\t\t\t\t\t\t\tlastUpdated = new Date(xmlDoc.querySelector('updated').textContent);\n\t\t\t\t\t\t\ttitle = xmlDoc.querySelector('title').textContent;\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\treject(e);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar result = {\n\t\t\t\t\t\t\ttitle: title,\n\t\t\t\t\t\t\tlastUpdated: lastUpdated,\n\t\t\t\t\t\t\tentries: {}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tfor (var i = 0; i < entries.length; i = i + 1) {\n\t\t\t\t\t\t\tvar temp = {};\n\t\t\t\t\t\t\tvar children = entries[i].childNodes;\n\n\t\t\t\t\t\t\tfor (var c = 0; c < children.length; c = c + 1) {\n\t\t\t\t\t\t\t\tif (children[c]) {\n\t\t\t\t\t\t\t\t\tif (children[c].tagName.toLowerCase().indexOf('gsx:') > -1) {\n\t\t\t\t\t\t\t\t\t\ttemp[children[c].tagName.split('gsx:')[1]] = children[c].textContent;\n\t\t\t\t\t\t\t\t\t} else if (children[c].tagName.toLowerCase() === 'id') {\n\t\t\t\t\t\t\t\t\t\ttemp.google_url = children[c].textContent;\n\t\t\t\t\t\t\t\t\t\ttemp.id = temp.google_url.split('/')[temp.google_url.split('/').length - 1];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (Object.keys(temp).length) {\n\t\t\t\t\t\t\t\tresult.entries[i] = temp;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (query) {\n\t\t\t\t\t\t\tvar searchResults = {};\n\n\t\t\t\t\t\t\tfor (var r in result.entries) {\n\t\t\t\t\t\t\t\tfor (var q in query) {\n\t\t\t\t\t\t\t\t\tfor (var o in query[q]) {\n\t\t\t\t\t\t\t\t\t\tswitch (o) {\n\t\t\t\t\t\t\t\t\t\t\tcase '>':\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && parseFloat(result.entries[r][q]) > query[q][o]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\t\tcase '<':\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && parseFloat(result.entries[r][q]) < query[q][o]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\tcase '>=':\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && parseFloat(result.entries[r][q]) >= query[q][o]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t\t\t\t\tcase '<=':\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && parseFloat(result.entries[r][q]) <= query[q][o]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\tcase 'like':\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && result.entries[r][q].indexOf(query[q][o]) > -1) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\t\t\t\tif (result.entries[r][q] && result.entries[r][q] === query[q][o]) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tsearchResults[r] = result.entries[r];\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresult.entries = searchResults;\n\n\t\t\t\t\t\t\treturn resolve(result);\n\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn resolve(result);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t},\n\n\n\n\t\t\tcreate: function (dataToSend, worksheet) {\n\n\t\t\t\tfor (var e = 0; e < dataToSend.length; e++){\n\t\t\t\t\tvar hex = '';\n\t\t\t\t\tfor (var i = 0; i < angular.toJson(dataToSend[e]).length; i++) {\n\t\t\t\t\t\thex += '' + angular.toJson(dataToSend[e]).charCodeAt(i).toString(16);\n\t\t\t\t\t}\n\t\t\t\t\tdataToSend[e].confirmationID = (new Date().getTime()) + '_' + hex;\n\t\t\t\t}\n\n\t\t\t\tvar postUrl = 'https://script.google.com/a/macros/' + domain + '/s/' + scriptID + '/dev?';\n\t\t\t\tpostUrl = postUrl + 'sheetId=' + sheetID + '&sheet=' + encodeURIComponent(self.worksheets[worksheet].title || self.worksheets[defaultWorksheet].title) + '&data=' + encodeURIComponent(angular.toJson(dataToSend));\n\n\t\t\t\treturn $q(function (resolve, reject) {\n\n\t\t\t\t\tfunction getNewData() {\n\t\t\t\t\t\tself.read(worksheet).then(function (res) {\n\n\t\t\t\t\t\t\tfor (var r in res.entries) {\n\t\t\t\t\t\t\t\tif (res.entries[r].confirmationid === dataToSend[0].confirmationID) {\n\t\t\t\t\t\t\t\t\treturn resolve(res);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn reject(res);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\t$http({\n\t\t\t\t\t\tmethod: 'jsonp',\n\t\t\t\t\t\turl: $sce.trustAsResourceUrl(postUrl),\n\t\t\t\t\t})\n\t\t\t\t\t\t.then(getNewData)\n\t\t\t\t\t\t// GOOGLE will always fail this\n\t\t\t\t\t\t.catch(getNewData);\n\t\t\t\t});\n\t\t\t},\n\n\n\n\t\t\tinit: function () {\n\t\t\t\tclearTimeout(timer);\n\n\t\t\t\tif ($http) {\n\t\t\t\t\t$http({\n\t\t\t\t\t\tmethod: 'get',\n\t\t\t\t\t\turl: 'sheets.config.json'\n\t\t\t\t\t}).then(function (res) {\n\t\t\t\t\t\tsheetID = res.data.sheetId;\n\t\t\t\t\t\tscriptID = res.data.scriptId;\n\t\t\t\t\t\tdomain = res.data.domain;\n\t\t\t\t\t\tself.setWorksheets();\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\ttimer = setTimeout(function () {\n\t\t\t\t\t\tself.init();\n\t\t\t\t\t}, 200);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tself.init();\n\n\t\treturn self;\n\t}\n\n\tgoogleSheetsService.$inject = [\n\t\t'$http',\n\t\t'$q',\n\t\t'$sce'\n\t];\n\n\tapp.service('googleSheetsService', googleSheetsService);\n})(angular.module('google-sheets-component', []));"]}